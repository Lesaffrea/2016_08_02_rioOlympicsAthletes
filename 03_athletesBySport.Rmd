---
title: "Athletes by sport type and nations"
author: "Duc-Quang Nguyen"
date: "2 Aug 2016"
output: html_document
---


## Data

### Grouping of sports
* Grouping of olympic sports: https://en.wikipedia.org/wiki/Olympic_sports
* https://en.wikipedia.org/wiki/Combat_sport#Olympic_Combat_Sports
* Team sports: https://en.wikipedia.org/wiki/Team_sport#Olympic_team_sports


```{r setup, include=FALSE}
library(readr)
library(tidyr)
library(dplyr)
library(magrittr)
library(countrycode)
library(ggplot2)
library(scales)
library(swiMap)
library(swiTheme)

### Interactive 
library(ggiraph)
library(svglite)
library(htmltools)
library(swiRcharts)

rio.file <- "input/athletes_rio2016.csv"
sports.file <- "input/summer Olympic sport grouping - Sheet1.csv"

countries <- data.frame(names = c(
  "Switzerland", "Brazil", "United States", "China", "Russia", 
   "India", "Japan", "Turkey", "Germany", "Italy", #"Portugal", 
  "France", "Spain", "United Kingdom")
)
countries$ioc <- countrycode(countries$names, "country.name", "ioc")

### Misc stuff
#require(classInt)
#require(viridis)
```

```{r load data}
athletes <- read_csv(rio.file)
sports <- read_csv(sports.file)

nrow(athletes)

idx <- match(athletes$sport, sports$sport)
stopifnot(!any(is.na(idx)))
athletes$group <- unlist(sports[idx, 'group'], use.names = F)

dat <- athletes %>% group_by(group, country, iso3) %>% summarise(value = length(athletes)) %>% ungroup()
dat %<>% group_by(country, iso3) %>% mutate(total = sum(value)) %>% ungroup()
dat$prop <- round((dat$value / dat$total) * 100)


data <- dat %>% filter(iso3 %in% countries$ioc)
d.all <- data %>% group_by(group) %>% 
  summarise(prop.all = (sum(value, na.rm = T) / sum(dat$value)) * 100) %>% 
  ungroup() %>% arrange(desc(prop.all))
d.all$group <- factor(d.all$group, levels = d.all$group)

# order factors
data$group <- factor(data$group, levels = d.all$group)
data$country <- gsub("Russian Federation", "Russia", data$country)
data$country <- factor(data$country, levels = as.character(countries$names))
data$iso2c <- countrycode(data$iso3, "ioc", "iso2c")


```

```{r visualize trial}
### ggplot2 theme
myTheme <- function(base_family = "OpenSans-CondensedLight", title_family = "OpenSans-CondensedBold") {
  swi_theme(base_size = 14, base_family = base_family, title_family = title_family, y_gridlines = F) +
    theme(
      strip.text.x = element_text(family = title_family, hjust = 0, vjust = 1, size = 14),
      #axis.text.x = element_text(angle = 45, hjust = 1,  margin = margin(t = -16), size = 11),
      axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, margin = margin(t = -17), size = 11.5),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      legend.position  = "none",
      plot.margin = unit(c(0.1, 0.3, 0, 0), "mm")
    )   
}

ggplot(data = data, aes(x = country, y = prop, group = country, fill = country)) + 
  geom_bar(stat = "identity") + facet_wrap(~ group, ncol = 4, scales = "free_y") + 
  myTheme() + 
  scale_fill_manual(values = swi_rpal, drop=FALSE) +
  scale_x_discrete(name = "", expand = c(0,0)) +
  geom_hline(data = d.all, aes(yintercept = prop.all), linetype = 7, size = 0.2, alpha = 0.6) +
  geom_text(aes(label = iso2c), vjust=1.5, color = "#f7f5ed", family =  "OpenSans-CondensedBold", size = 3)

```

## Generate each sport group as a standaline graphic

(instead of faceting)

```{r prod graphics}
### print interactive chart
interactive_chart <- function(gpath, fontname = 'Open Sans Condensed') {
  ggiraph(
    code = {print(gpath)},
    hover_css = "fill-opacity:0.6;stroke-opacity:0.9;stroke-width:1.1px;stroke:#333333;",
    tooltip_opacity = 0.7,
    pointsize = 12,
    width = "100%",
    height_svg = 5,
    width_svg = 4,
    fontname_sans = fontname,
    fontname_serif = fontname
  ) 
}


gr <- 'Team Sports'
maxV <- data %>% group_by(group, country) %>% summarise(max = max(prop, na.rm = T)) %>% ungroup() %>% unlist(use.names = F) %>% max()

# interactive!
charts <- lapply(levels(data$group), function(gr) {
  
  dd <- data %>% filter(group == gr)
  underlying.sports <- unlist(sports[which(sports$group == gr),'sport'], use.names = F)
  dd$tooltip <- paste0(
    "<b>", as.character(dd$country), "</b><br>",
    dd$prop, "%<br>",
        '<div><span style="font-size: 0.8em">',
    "(", dd$value, " / ", dd$total, ")",
    "</span></div>"
  )    
    
  chart <- ggplot(data = dd, aes(x = country, tooltip = tooltip, data_id_ = country, y = prop, group = country, fill = country)) + 
    geom_bar_interactive(stat = "identity")  +
    myTheme() + 
    scale_fill_manual(values = swi_rpal, drop = F) +
    scale_y_continuous(name = "", breaks = pretty_breaks(n = 3), limits = c(0, maxV)) + 
    scale_x_discrete(name = "", expand = c(0,0.1), drop=FALSE)
  gg <- chart +
    geom_hline(data = d.all %>% filter(group == gr), aes(yintercept = prop.all), linetype = 3, size = 0.8, alpha = 0.9, colour = "#ffe6ff") +
    geom_text(aes(label = iso2c), vjust = 1.8, color = "#f7f5ed", family =  "OpenSans-CondensedBold", size = 3) 
  list(chart = gg, title = gr, subtitle = paste(underlying.sports, collapse =", "))
})




 save_html(
  tags$html(
    tags$head(includeHTML("styles.html")),
    tags$body(
    h2(HTML("Rio 2016 olympics - how country delegations differs in sports?")),
    div(class = "descr",  HTML("Percentage by country delegation and by sport groups of athletes competing at the Rio 2016 summer olympics. The dotted horizontal line correspond to proportion of athletes over all nations.<br>The different sport groups are shown by order of importance")),
    div(class = "container",
     lapply(1:length(charts), function(i) {
       div(class = "graphic", 
          h3(HTML(charts[[i]]$title)),
          div(class = "subtitle",  HTML(charts[[i]]$subtitle)),
          interactive_chart(charts[[i]]$chart)
       )      
     })
    ),
    HTML(iframeresizer)
    )), file = "interactive_dev.html", libdir = "js"
  )
 



```